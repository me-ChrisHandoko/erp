// This is your Prisma schema file for ERP Distribusi Sembako
// PHASE 0 IMPLEMENTATION - Critical Features Added
// Version: 2.0 (Phase 0 - Pre-Launch)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // Change to "postgresql" or "mysql" for production
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String   // Should be hashed
  name      String
  role      UserRole @default(STAFF)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  salesOrders        SalesOrder[]
  purchaseOrders     PurchaseOrder[]
  invoices           Invoice[]
  cashTransactions   CashTransaction[]
  inventoryMovements InventoryMovement[]
  supplierPayments   SupplierPayment[]
  deliveries         Delivery[]
  goodsReceipts      GoodsReceipt[]        // NEW: GRN created by
  stockOpnames       StockOpname[]         // NEW: Stock opname by
  managedWarehouses  Warehouse[]           // NEW: Warehouse manager

  @@map("users")
}

enum UserRole {
  OWNER
  ADMIN
  FINANCE
  SALES
  WAREHOUSE
  STAFF
}

// ============================================
// COMPANY PROFILE & SETTINGS
// ============================================

model Company {
  id            String   @id @default(cuid())

  // Legal Entity Information
  name          String   // Display name: "CV. BG ENERGY KIMOCHI"
  legalName     String   // Full legal name for official documents
  entityType    String   @default("CV") // CV, PT, UD, Firma, etc.

  // Address
  address       String   @db.Text
  city          String
  province      String
  postalCode    String?
  country       String   @default("Indonesia")

  // Contact
  phone         String
  email         String
  website       String?

  // Indonesian Tax Compliance
  npwp          String?  @unique // Nomor Pokok Wajib Pajak (Tax ID)
  isPKP         Boolean  @default(false) // Pengusaha Kena Pajak
  ppnRate       Decimal  @default(11) @db.Decimal(5, 2) // PPN rate (11% in 2025)
  fakturPajakSeries String? // Series Faktur Pajak
  sppkpNumber   String?  // Surat Pengukuhan PKP number

  // Branding
  logoUrl       String?  // Path to company logo
  primaryColor  String?  @default("#1E40AF") // Hex color
  secondaryColor String? @default("#64748B") // Hex color

  // Invoice Settings
  invoicePrefix        String  @default("INV")
  invoiceNumberFormat  String  @default("{PREFIX}/{NUMBER}/{MONTH}/{YEAR}") // e.g., "INV/001/12/2025"
  invoiceFooter        String? @db.Text // Footer text for invoices
  invoiceTerms         String? @db.Text // Payment terms and conditions

  // Sales Order Settings
  soPrefix            String  @default("SO")
  soNumberFormat      String  @default("{PREFIX}{NUMBER}")

  // Purchase Order Settings
  poPrefix            String  @default("PO")
  poNumberFormat      String  @default("{PREFIX}{NUMBER}")

  // System Settings
  currency      String  @default("IDR")
  timezone      String  @default("Asia/Jakarta")
  locale        String  @default("id-ID")

  // Business Hours
  businessHoursStart String? @default("08:00") // HH:mm format
  businessHoursEnd   String? @default("17:00")
  workingDays        String? @default("1,2,3,4,5") // 0=Sunday, 1=Monday, etc.

  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  banks         CompanyBank[]

  @@map("companies")
}

model CompanyBank {
  id              String   @id @default(cuid())
  companyId       String

  bankName        String   // "BCA", "Mandiri", "BRI", etc.
  accountNumber   String
  accountName     String   // Account holder name
  branchName      String?  // Bank branch

  isPrimary       Boolean  @default(false) // Primary bank for invoices

  // For checks/giro
  checkPrefix     String?  // Prefix for check numbers

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([isPrimary])
  @@map("company_banks")
}

// ============================================
// WAREHOUSE MANAGEMENT (NEW - PHASE 0)
// ============================================

model Warehouse {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "WH001", "GD-PUSAT", "CB-JAKARTA"
  name        String   // e.g., "Gudang Pusat", "Cabang Jakarta"

  // Type
  type        WarehouseType @default(MAIN)

  // Address
  address     String?  @db.Text
  city        String?
  province    String?
  postalCode  String?

  // Contact
  phone       String?
  email       String?

  // Management
  managerId   String?  // User who manages this warehouse

  // Capacity (optional)
  capacity    Decimal? @db.Decimal(15, 2) // Square meters or volume

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  manager            User?              @relation(fields: [managerId], references: [id])
  stocks             WarehouseStock[]
  inventoryMovements InventoryMovement[]
  goodsReceipts      GoodsReceipt[]
  deliveries         Delivery[]
  stockOpnames       StockOpname[]
  stockTransfers     StockTransfer[]    @relation("TransferFrom")
  receivedTransfers  StockTransfer[]    @relation("TransferTo")

  @@index([code])
  @@index([type])
  @@index([managerId])
  @@map("warehouses")
}

enum WarehouseType {
  MAIN         // Gudang utama/pusat
  BRANCH       // Cabang/branch
  CONSIGNMENT  // Titipan di customer
  TRANSIT      // Gudang transit/antara
}

model WarehouseStock {
  id          String   @id @default(cuid())
  warehouseId String
  productId   String

  // Stock quantity (always in base unit)
  quantity    Decimal  @default(0) @db.Decimal(15, 3)

  // Stock levels
  minimumStock Decimal @default(0) @db.Decimal(15, 3)
  maximumStock Decimal @default(0) @db.Decimal(15, 3)

  // Location within warehouse (optional)
  location    String?  // e.g., "RAK-A-01", "BIN-12", "ZONE-B"

  // Last stock count
  lastCountDate DateTime?
  lastCountQty  Decimal?  @db.Decimal(15, 3)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  batches   ProductBatch[]

  @@unique([warehouseId, productId])
  @@index([warehouseId])
  @@index([productId])
  @@index([quantity]) // For low stock queries
  @@map("warehouse_stocks")
}

// ============================================
// CUSTOMER & SUPPLIER MANAGEMENT
// ============================================

model Customer {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "CUST001"
  name        String
  address     String?
  city        String?
  phone       String?
  email       String?
  contactPerson String?

  // Payment terms
  creditLimit    Decimal  @default(0) @db.Decimal(15, 2)
  paymentTerms   Int      @default(30) // days
  taxNumber      String?  // NPWP

  // NEW: Outstanding tracking (PHASE 0)
  currentOutstanding Decimal @default(0) @db.Decimal(15, 2) // Total piutang
  overdueAmount      Decimal @default(0) @db.Decimal(15, 2) // Piutang jatuh tempo
  lastPaymentDate    DateTime? // Tanggal bayar terakhir

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  salesOrders SalesOrder[]
  invoices    Invoice[]
  deliveries  Delivery[]

  @@index([name])
  @@index([currentOutstanding]) // NEW: For AR reports
  @@map("customers")
}

model Supplier {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "SUPP001"
  name        String
  address     String?
  city        String?
  phone       String?
  email       String?
  contactPerson String?

  // Payment terms
  paymentTerms   Int      @default(30) // days
  taxNumber      String?  // NPWP

  // NEW: Outstanding tracking (PHASE 0)
  currentOutstanding Decimal @default(0) @db.Decimal(15, 2) // Total hutang
  overdueAmount      Decimal @default(0) @db.Decimal(15, 2) // Hutang jatuh tempo
  lastPaymentDate    DateTime? // Tanggal bayar terakhir

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  purchaseOrders   PurchaseOrder[]
  productSuppliers ProductSupplier[]

  @@index([name])
  @@index([currentOutstanding]) // NEW: For AP reports
  @@map("suppliers")
}

// ============================================
// PRODUCT & INVENTORY MANAGEMENT
// ============================================

model Product {
  id          String   @id @default(cuid())
  code        String   @unique // SKU
  name        String
  category    String?

  // Unit Management - Base unit untuk stock calculation
  baseUnit    String   @default("PCS") // Unit terkecil: PCS, KG, LITER, etc.

  // Pricing (base pricing, per-unit pricing ada di ProductUnit)
  baseCost       Decimal  @default(0) @db.Decimal(15, 2)
  basePrice      Decimal  @default(0) @db.Decimal(15, 2)

  // Inventory - DEPRECATED: Use WarehouseStock instead
  // Kept for backward compatibility during migration
  currentStock   Decimal  @default(0) @db.Decimal(15, 3)
  minimumStock   Decimal  @default(0) @db.Decimal(15, 3)

  // Product info
  description    String?  @db.Text
  barcode        String?  @unique

  // NEW: Batch tracking control (PHASE 0)
  isBatchTracked Boolean  @default(false) // True if this product requires batch/lot tracking
  isPerishable   Boolean  @default(false) // True if product has expiry date

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  units               ProductUnit[]
  priceList           PriceList[]
  salesOrderItems     SalesOrderItem[]
  invoiceItems        InvoiceItem[]
  purchaseOrderItems  PurchaseOrderItem[]
  inventoryMovements  InventoryMovement[]
  productSuppliers    ProductSupplier[]
  deliveryItems       DeliveryItem[]
  warehouseStocks     WarehouseStock[]      // NEW: Per-warehouse stock
  batches             ProductBatch[]        // NEW: Batch tracking
  goodsReceiptItems   GoodsReceiptItem[]    // NEW: GRN items

  @@index([name])
  @@index([code])
  @@index([isBatchTracked]) // NEW: Query batch-tracked products
  @@map("products")
}

// ============================================
// PRODUCT BATCH/LOT TRACKING (NEW - PHASE 0)
// ============================================

model ProductBatch {
  id              String   @id @default(cuid())
  batchNumber     String   // e.g., "BATCH-2025-001", "LOT-ABC123"
  productId       String
  warehouseStockId String  // Which warehouse stock this batch belongs to

  // Batch information
  manufactureDate DateTime?
  expiryDate      DateTime? // CRITICAL for sembako (food items)

  // Quantity (in base unit)
  quantity        Decimal  @db.Decimal(15, 3)

  // Source
  supplierId      String?  // Which supplier this batch came from
  goodsReceiptId  String?  // Which GRN this batch was received in
  receiptDate     DateTime @default(now())

  // Status
  status          BatchStatus @default(AVAILABLE)

  // Quality
  qualityStatus   String?  @default("GOOD") // GOOD, DAMAGED, QUARANTINE

  // Reference
  referenceNumber String?  // Supplier's batch/lot number
  notes           String?  @db.Text

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  product         Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouseStock  WarehouseStock  @relation(fields: [warehouseStockId], references: [id], onDelete: Cascade)
  goodsReceipt    GoodsReceipt?   @relation(fields: [goodsReceiptId], references: [id])
  movements       InventoryMovement[]
  deliveryItems   DeliveryItem[]

  @@unique([batchNumber, productId])
  @@index([productId])
  @@index([warehouseStockId])
  @@index([expiryDate]) // CRITICAL: Query expiring batches
  @@index([status])
  @@index([goodsReceiptId])
  @@map("product_batches")
}

enum BatchStatus {
  AVAILABLE   // Available for sale
  RESERVED    // Reserved for sales order
  EXPIRED     // Past expiry date
  DAMAGED     // Damaged/defective
  RECALLED    // Product recall
  SOLD        // Fully sold out
}

// Multi-customer pricing (from "Update Harga" sheet)
model PriceList {
  id         String   @id @default(cuid())
  productId  String
  customerId String?  // NULL = default price for all
  price      Decimal  @db.Decimal(15, 2)
  minQty     Decimal  @default(0) @db.Decimal(15, 3)

  effectiveFrom DateTime @default(now())
  effectiveTo   DateTime?

  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, customerId])
  @@map("price_list")
}

// Supplier-Product relationship (which supplier supplies which product)
model ProductSupplier {
  id         String   @id @default(cuid())
  productId  String
  supplierId String

  supplierPrice Decimal @db.Decimal(15, 2)
  leadTime      Int     @default(7) // days
  isPrimary     Boolean @default(false)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([productId, supplierId])
  @@map("product_suppliers")
}

// Product Unit Conversion (Multi-unit support untuk distribusi)
model ProductUnit {
  id              String  @id @default(cuid())
  productId       String

  unitName        String   // "PCS", "KARTON", "LUSIN", "PACK", "SACK", "KG", "LITER", etc.
  conversionRate  Decimal  @db.Decimal(15, 3) // Konversi ke base unit. Contoh: 1 KARTON = 24 PCS
  isBaseUnit      Boolean  @default(false)     // True jika ini base unit (sama dengan Product.baseUnit)

  // Pricing per unit (optional, bisa berbeda per unit)
  buyPrice        Decimal? @db.Decimal(15, 2)  // Harga beli per unit ini
  sellPrice       Decimal? @db.Decimal(15, 2)  // Harga jual default per unit ini

  // Barcode per unit (setiap unit bisa punya barcode berbeda)
  barcode         String?  // Contoh: barcode karton beda dengan barcode pcs
  sku             String?  // SKU khusus untuk unit ini

  // Product info
  weight          Decimal? @db.Decimal(10, 3)  // Berat per unit (kg)
  volume          Decimal? @db.Decimal(10, 3)  // Volume per unit (m³)
  description     String?  @db.Text            // Deskripsi unit

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, unitName])
  @@index([productId])
  @@index([barcode])
  @@map("product_units")
}

// ============================================
// SALES ORDER MANAGEMENT (Orders from Customers)
// ============================================

model SalesOrder {
  id          String   @id @default(cuid())
  soNumber    String   @unique // e.g., "SO001", "SO002"
  soDate      DateTime @default(now())
  customerId  String

  // Reference
  customerPONumber String? // Customer's internal PO number
  specification    String? // From "Spec" column
  notes            String? @db.Text

  // Status tracking - SIMPLIFIED (PHASE 0)
  status      SalesOrderStatus @default(DRAFT)

  // Amounts (calculated from items)
  subtotal    Decimal  @default(0) @db.Decimal(15, 2)
  discount    Decimal  @default(0) @db.Decimal(15, 2)
  tax         Decimal  @default(0) @db.Decimal(15, 2)
  total       Decimal  @default(0) @db.Decimal(15, 2)

  // Fulfillment
  deliveryDate DateTime?
  deliveryAddress String? @db.Text

  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  customer   Customer @relation(fields: [customerId], references: [id])
  createdBy  User     @relation(fields: [createdById], references: [id])
  items      SalesOrderItem[]
  invoices   Invoice[]
  deliveries Delivery[]

  @@index([soNumber])
  @@index([customerId])
  @@index([soDate])
  @@index([status])
  @@map("sales_orders")
}

model SalesOrderItem {
  id            String   @id @default(cuid())
  salesOrderId  String
  productId     String

  // Unit specification - customer bisa pesan dalam unit apapun
  unitName     String   @default("PCS") // Unit yang dipesan: "PCS", "KARTON", "LUSIN", etc.
  quantity     Decimal  @db.Decimal(15, 3)
  unitPrice    Decimal  @db.Decimal(15, 2) // Harga per unitName (bukan per base unit)
  discount     Decimal  @default(0) @db.Decimal(15, 2)
  subtotal     Decimal  @db.Decimal(15, 2) // quantity * unitPrice - discount

  notes        String? @db.Text

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  salesOrder    SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  product       Product    @relation(fields: [productId], references: [id])
  deliveryItems DeliveryItem[]

  @@index([salesOrderId])
  @@map("sales_order_items")
}

// SIMPLIFIED STATUS (PHASE 0: 7 states → 4 states)
enum SalesOrderStatus {
  DRAFT      // Belum dikonfirmasi
  CONFIRMED  // Sudah dikonfirmasi, ready untuk diproses
  COMPLETED  // Selesai (sudah delivered & invoiced)
  CANCELLED  // Dibatalkan
}

// ============================================
// INVOICE MANAGEMENT (Sales Invoice)
// ============================================

model Invoice {
  id             String   @id @default(cuid())
  invoiceNumber  String   @unique // e.g., "474/12/2025"
  invoiceDate    DateTime @default(now())
  dueDate        DateTime

  customerId     String
  salesOrderId   String? // Can be NULL if direct invoice

  // Amounts
  subtotal       Decimal  @default(0) @db.Decimal(15, 2)
  discount       Decimal  @default(0) @db.Decimal(15, 2)
  tax            Decimal  @default(0) @db.Decimal(15, 2)
  total          Decimal  @default(0) @db.Decimal(15, 2)

  // Payment tracking
  paidAmount     Decimal  @default(0) @db.Decimal(15, 2)
  paymentStatus  PaymentStatus @default(UNPAID)
  paymentDate    DateTime?

  notes          String?  @db.Text

  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  customer    Customer     @relation(fields: [customerId], references: [id])
  salesOrder  SalesOrder?  @relation(fields: [salesOrderId], references: [id])
  createdBy   User         @relation(fields: [createdById], references: [id])
  items       InvoiceItem[]
  payments    Payment[]
  deliveries  InvoiceDelivery[] // Many-to-many with Delivery

  @@index([invoiceNumber])
  @@index([customerId])
  @@index([invoiceDate])
  @@index([paymentStatus])
  @@index([dueDate]) // NEW: For aging reports
  @@map("invoices")
}

model InvoiceItem {
  id         String   @id @default(cuid())
  invoiceId  String
  productId  String

  // Unit specification - invoice dalam unit yang sama dengan sales order
  unitName   String   @default("PCS") // Unit yang ditagihkan: "PCS", "KARTON", "LUSIN", etc.
  quantity   Decimal  @db.Decimal(15, 3)
  unitPrice  Decimal  @db.Decimal(15, 2) // Harga per unitName
  discount   Decimal  @default(0) @db.Decimal(15, 2)
  subtotal   Decimal  @db.Decimal(15, 2)

  notes      String? @db.Text

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([invoiceId])
  @@map("invoice_items")
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
}

// ============================================
// PAYMENT TRACKING
// ============================================

model Payment {
  id            String   @id @default(cuid())
  invoiceId     String
  paymentDate   DateTime @default(now())
  amount        Decimal  @db.Decimal(15, 2)

  paymentMethod PaymentMethod @default(TRANSFER)
  reference     String?  // Transfer reference, check number, etc.

  notes         String?  @db.Text

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([paymentDate])
  @@map("payments")
}

enum PaymentMethod {
  CASH
  TRANSFER
  CHECK
  GIRO
  OTHER
}

enum CheckStatus {
  ISSUED    // Check/giro diterbitkan tapi belum cair
  CLEARED   // Check/giro sudah cair
  BOUNCED   // Check/giro ditolak/gagal cair
  CANCELLED // Check/giro dibatalkan
}

// ============================================
// PURCHASE ORDER & GOODS RECEIPT (UPDATED - PHASE 0)
// ============================================

model PurchaseOrder {
  id            String   @id @default(cuid())
  poNumber      String   @unique
  poDate        DateTime @default(now())
  supplierId    String

  // Amounts
  subtotal      Decimal  @default(0) @db.Decimal(15, 2)
  discount      Decimal  @default(0) @db.Decimal(15, 2)
  tax           Decimal  @default(0) @db.Decimal(15, 2)
  total         Decimal  @default(0) @db.Decimal(15, 2)

  // Payment tracking
  paidAmount    Decimal  @default(0) @db.Decimal(15, 2)
  paymentStatus PaymentStatus @default(UNPAID)
  dueDate       DateTime?

  notes         String?  @db.Text

  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  supplier       Supplier        @relation(fields: [supplierId], references: [id])
  createdBy      User            @relation(fields: [createdById], references: [id])
  items          PurchaseOrderItem[]
  payments       SupplierPayment[]
  goodsReceipts  GoodsReceipt[]  // NEW: Link to goods receipts

  @@index([poNumber])
  @@index([supplierId])
  @@index([poDate])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id               String   @id @default(cuid())
  purchaseOrderId  String
  productId        String

  // Unit specification - beli dari supplier dalam unit apapun
  unitName         String   @default("PCS") // Unit yang dibeli: "PCS", "KARTON", "SACK", etc.
  quantity         Decimal  @db.Decimal(15, 3)
  unitCost         Decimal  @db.Decimal(15, 2) // Harga beli per unitName (bukan per base unit)
  discount         Decimal  @default(0) @db.Decimal(15, 2)
  subtotal         Decimal  @db.Decimal(15, 2)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])

  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}

// ============================================
// GOODS RECEIPT NOTE - GRN (NEW - PHASE 0)
// ============================================

model GoodsReceipt {
  id              String   @id @default(cuid())
  receiptNumber   String   @unique // e.g., "GRN001", "GRN-2025-001"
  receiptDate     DateTime @default(now())

  purchaseOrderId String
  warehouseId     String   // Which warehouse receives the goods
  supplierId      String   // Direct from PO, but denormalized for easy query

  // Status
  status          GoodsReceiptStatus @default(PENDING)

  // Amounts (for verification against PO)
  subtotal        Decimal  @default(0) @db.Decimal(15, 2)
  discount        Decimal  @default(0) @db.Decimal(15, 2)
  tax             Decimal  @default(0) @db.Decimal(15, 2)
  total           Decimal  @default(0) @db.Decimal(15, 2)

  // Supplier document reference
  supplierInvoice String?  // Supplier's invoice/delivery note number
  supplierDate    DateTime? // Date on supplier's document

  // Quality inspection
  inspectedBy     String?  // User who inspected
  inspectionDate  DateTime?
  inspectionNotes String?  @db.Text

  // Delivery info
  driverName      String?
  vehicleNumber   String?

  notes           String?  @db.Text

  createdById     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  warehouse     Warehouse     @relation(fields: [warehouseId], references: [id])
  createdBy     User          @relation(fields: [createdById], references: [id])
  items         GoodsReceiptItem[]
  batches       ProductBatch[] // Batches created from this GRN

  @@index([receiptNumber])
  @@index([purchaseOrderId])
  @@index([warehouseId])
  @@index([receiptDate])
  @@index([status])
  @@map("goods_receipts")
}

model GoodsReceiptItem {
  id              String   @id @default(cuid())
  goodsReceiptId  String
  productId       String

  // Ordered vs Received quantities
  orderedQty      Decimal  @db.Decimal(15, 3) // From PO
  receivedQty     Decimal  @db.Decimal(15, 3) // Actually received
  acceptedQty     Decimal  @default(0) @db.Decimal(15, 3) // Accepted after inspection
  rejectedQty     Decimal  @default(0) @db.Decimal(15, 3) // Rejected (damaged, wrong, etc.)

  unitName        String   @default("PCS") // Unit yang diterima
  unitCost        Decimal  @db.Decimal(15, 2) // Cost per unit (from PO)

  // Batch information (if product is batch-tracked)
  batchNumber     String?  // Batch/lot number from supplier
  manufactureDate DateTime?
  expiryDate      DateTime?

  // Rejection reason (if any)
  rejectionReason String?  @db.Text

  notes           String?  @db.Text

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  goodsReceipt GoodsReceipt @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  product      Product      @relation(fields: [productId], references: [id])

  @@index([goodsReceiptId])
  @@index([productId])
  @@map("goods_receipt_items")
}

enum GoodsReceiptStatus {
  PENDING    // GRN created, waiting for goods to arrive
  RECEIVED   // Goods physically received, not yet inspected
  INSPECTED  // Quality inspection done
  ACCEPTED   // Goods accepted, stock updated
  REJECTED   // Goods rejected, no stock update
  PARTIAL    // Partially accepted (some items rejected)
}

// Supplier Payment Tracking (Hutang ke Supplier)
model SupplierPayment {
  id               String   @id @default(cuid())
  purchaseOrderId  String

  paymentDate      DateTime @default(now())
  amount           Decimal  @db.Decimal(15, 2)

  paymentMethod    PaymentMethod @default(TRANSFER)
  reference        String?  // Transfer reference, invoice number, etc.

  // For check/giro tracking
  checkNumber      String?  // Nomor check atau giro
  checkDate        DateTime? // Tanggal jatuh tempo check/giro
  checkStatus      CheckStatus? // Status check/giro
  bankName         String?  // Bank penerbit check/giro

  notes            String?  @db.Text

  createdById      String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  createdBy     User          @relation(fields: [createdById], references: [id])

  @@index([purchaseOrderId])
  @@index([paymentDate])
  @@index([checkNumber])
  @@index([checkStatus])
  @@map("supplier_payments")
}

// ============================================
// INVENTORY MANAGEMENT (UPDATED - PHASE 0)
// ============================================

model InventoryMovement {
  id          String   @id @default(cuid())
  productId   String
  warehouseId String   // NEW: Which warehouse (PHASE 0)
  batchId     String?  // NEW: Which batch (if batch-tracked) (PHASE 0)

  type        MovementType
  quantity    Decimal      @db.Decimal(15, 3)

  // Reference (what caused this movement)
  referenceType String? // e.g., "GOODS_RECEIPT", "DELIVERY", "ADJUSTMENT", "TRANSFER"
  referenceId   String? // ID of the GRN, delivery, etc.

  // Stock calculation
  stockBefore Decimal @db.Decimal(15, 3)
  stockAfter  Decimal @db.Decimal(15, 3)

  notes       String? @db.Text

  createdById String
  createdAt   DateTime @default(now())

  // Relations
  product   Product       @relation(fields: [productId], references: [id])
  warehouse Warehouse     @relation(fields: [warehouseId], references: [id])
  batch     ProductBatch? @relation(fields: [batchId], references: [id])
  createdBy User          @relation(fields: [createdById], references: [id])

  @@index([productId])
  @@index([warehouseId]) // NEW
  @@index([batchId])     // NEW
  @@index([createdAt])
  @@index([referenceType, referenceId]) // NEW: Query movements by reference
  @@map("inventory_movements")
}

enum MovementType {
  IN        // Stock masuk (dari supplier via GRN)
  OUT       // Stock keluar (ke customer via delivery)
  ADJUSTMENT // Stock opname adjustment
  RETURN    // Return dari customer
  DAMAGED   // Barang rusak
  TRANSFER  // Transfer antar gudang (NEW)
}

// ============================================
// STOCK OPNAME (NEW - PHASE 0)
// ============================================

model StockOpname {
  id             String   @id @default(cuid())
  opnameNumber   String   @unique // e.g., "OP-2025-001"
  opnameDate     DateTime @default(now())
  warehouseId    String

  status         StockOpnameStatus @default(DRAFT)

  // Approval
  approvedBy     String?
  approvedAt     DateTime?

  // Summary
  totalVariance  Decimal  @default(0) @db.Decimal(15, 2) // Total value variance

  notes          String?  @db.Text

  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  createdBy User      @relation(fields: [createdById], references: [id])
  items     StockOpnameItem[]

  @@index([opnameNumber])
  @@index([warehouseId])
  @@index([opnameDate])
  @@index([status])
  @@map("stock_opnames")
}

model StockOpnameItem {
  id            String   @id @default(cuid())
  opnameId      String
  productId     String
  batchId       String?  // If batch-tracked

  systemQty     Decimal  @db.Decimal(15, 3) // Quantity per system
  actualQty     Decimal  @db.Decimal(15, 3) // Counted quantity
  variance      Decimal  @db.Decimal(15, 3) // Difference
  varianceValue Decimal  @db.Decimal(15, 2) // Value of variance

  unitCost      Decimal  @db.Decimal(15, 2) // Cost per unit (for variance calc)

  notes         String?  @db.Text

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  opname  StockOpname   @relation(fields: [opnameId], references: [id], onDelete: Cascade)

  @@index([opnameId])
  @@map("stock_opname_items")
}

enum StockOpnameStatus {
  DRAFT      // Being counted
  COMPLETED  // Counting done, not yet approved
  APPROVED   // Approved, adjustments posted
  CANCELLED  // Cancelled
}

// ============================================
// STOCK TRANSFER (NEW - PHASE 0)
// ============================================

model StockTransfer {
  id             String   @id @default(cuid())
  transferNumber String   @unique // e.g., "ST-2025-001"
  transferDate   DateTime @default(now())

  fromWarehouseId String
  toWarehouseId   String

  status         StockTransferStatus @default(DRAFT)

  // Shipping info
  shippedBy      String?  // Driver/person
  shippedAt      DateTime?

  // Receiving info
  receivedBy     String?  // User who received
  receivedAt     DateTime?

  notes          String?  @db.Text

  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  fromWarehouse Warehouse @relation("TransferFrom", fields: [fromWarehouseId], references: [id])
  toWarehouse   Warehouse @relation("TransferTo", fields: [toWarehouseId], references: [id])
  items         StockTransferItem[]

  @@index([transferNumber])
  @@index([fromWarehouseId])
  @@index([toWarehouseId])
  @@index([status])
  @@map("stock_transfers")
}

model StockTransferItem {
  id            String   @id @default(cuid())
  transferId    String
  productId     String
  batchId       String?  // If batch-tracked

  quantity      Decimal  @db.Decimal(15, 3)
  unitName      String   @default("PCS")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  transfer StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)

  @@index([transferId])
  @@map("stock_transfer_items")
}

enum StockTransferStatus {
  DRAFT       // Created, not yet shipped
  SHIPPED     // Shipped from source warehouse
  RECEIVED    // Received at destination warehouse
  CANCELLED   // Cancelled
}

// ============================================
// DELIVERY MANAGEMENT (UPDATED - PHASE 0)
// ============================================

model Delivery {
  id              String   @id @default(cuid())
  deliveryNumber  String   @unique // e.g., "SJ001", "SJ002"
  deliveryDate    DateTime @default(now())

  salesOrderId    String
  customerId      String
  warehouseId     String   // NEW: From which warehouse (PHASE 0)

  // Delivery type
  type            DeliveryType @default(NORMAL)
  referenceId     String?  // If RETURN, reference to original delivery

  // Status tracking - SIMPLIFIED (PHASE 0)
  status          DeliveryStatus @default(PREPARED)

  // Logistics
  driverName      String?
  vehicleNumber   String?  // Nomor plat kendaraan
  helperName      String?  // Nama kernet/helper

  // Timing
  departureTime   DateTime?
  estimatedArrival DateTime?
  actualArrival   DateTime?

  // Proof of Delivery
  receivedBy      String?   // Nama penerima
  receivedAt      DateTime? // Waktu actual terima
  signature       String?   // Path to signature image/file
  photoProof      String?   // Path to photo barang

  // TTNK tracking (jika pakai jasa ekspedisi)
  ttnkNumber      String?   // Nomor resi ekspedisi
  ttnkDeadline    DateTime? // Deadline pengiriman ekspedisi
  expeditionName  String?   // "JNE", "Sicepat", "JNT", etc.

  notes           String?  @db.Text

  createdById     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id])
  customer     Customer @relation(fields: [customerId], references: [id])
  warehouse    Warehouse @relation(fields: [warehouseId], references: [id])
  items        DeliveryItem[]
  invoices     InvoiceDelivery[] // Many-to-many with Invoice
  createdBy    User @relation(fields: [createdById], references: [id])

  @@index([deliveryNumber])
  @@index([salesOrderId])
  @@index([customerId])
  @@index([warehouseId]) // NEW
  @@index([status])
  @@index([deliveryDate])
  @@map("deliveries")
}

model DeliveryItem {
  id          String   @id @default(cuid())
  deliveryId  String
  productId   String
  batchId     String?  // NEW: Which batch was delivered (PHASE 0)

  // Quantity yang dikirim (bisa partial dari SO)
  unitName    String   @default("PCS") // Unit yang dikirim
  quantity    Decimal  @db.Decimal(15, 3)

  // Reference dari SO item (optional)
  salesOrderItemId String?

  // Condition tracking
  condition   String?  @default("GOOD") // "GOOD", "DAMAGED", "INCOMPLETE"
  notes       String?  @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  delivery        Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  product         Product @relation(fields: [productId], references: [id])
  batch           ProductBatch? @relation(fields: [batchId], references: [id])
  salesOrderItem  SalesOrderItem? @relation(fields: [salesOrderItemId], references: [id])

  @@index([deliveryId])
  @@index([productId])
  @@index([batchId]) // NEW
  @@map("delivery_items")
}

// Junction table untuk many-to-many relationship Invoice <-> Delivery
model InvoiceDelivery {
  id          String   @id @default(cuid())
  invoiceId   String
  deliveryId  String

  createdAt   DateTime @default(now())

  // Relations
  invoice  Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  delivery Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@unique([invoiceId, deliveryId])
  @@index([invoiceId])
  @@index([deliveryId])
  @@map("invoice_deliveries")
}

enum DeliveryType {
  NORMAL       // Pengiriman normal
  RETURN       // Return dari customer
  REPLACEMENT  // Penggantian barang rusak
}

// SIMPLIFIED STATUS (PHASE 0: 8 states → 5 states)
enum DeliveryStatus {
  PREPARED   // Barang disiapkan di gudang
  IN_TRANSIT // Dalam perjalanan
  DELIVERED  // Sudah sampai (belum konfirmasi customer)
  CONFIRMED  // Customer sudah konfirmasi terima (FINAL)
  CANCELLED  // Dibatalkan
}

// ============================================
// FINANCIAL MANAGEMENT (Buku Kas)
// ============================================

model CashTransaction {
  id              String   @id @default(cuid())
  transactionDate DateTime @default(now())

  type            TransactionType
  category        String   // e.g., "Penjualan", "Pembelian", "Gaji", "Operasional"

  amount          Decimal  @db.Decimal(15, 2)

  // Reference
  referenceType   String?  // e.g., "INVOICE", "PURCHASE_ORDER", "MANUAL"
  referenceId     String?
  referenceNumber String?  // Invoice number, purchase number, etc.

  description     String   @db.Text
  notes           String?  @db.Text

  // Running balance
  balanceBefore   Decimal  @db.Decimal(15, 2)
  balanceAfter    Decimal  @db.Decimal(15, 2)

  createdById     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  createdBy User @relation(fields: [createdById], references: [id])

  @@index([transactionDate])
  @@index([type])
  @@index([category])
  @@map("cash_transactions")
}

enum TransactionType {
  IN   // Pemasukan (debit)
  OUT  // Pengeluaran (credit)
}

// ============================================
// SYSTEM SETTINGS & CONFIGURATION
// ============================================

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  category  String   // e.g., "COMPANY", "INVOICE", "SYSTEM"

  description String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("settings")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?

  action     String   // CREATE, UPDATE, DELETE
  entity     String   // Table name
  entityId   String   // Record ID

  oldValue   Json?
  newValue   Json?

  ipAddress  String?
  userAgent  String?

  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
